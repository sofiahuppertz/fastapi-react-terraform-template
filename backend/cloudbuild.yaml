# Google Cloud Build configuration for CI/CD
# This file automates building and deploying your API to Cloud Run
#
# Usage:
#   gcloud builds submit --config=cloudbuild.yaml --project=YOUR_PROJECT_ID
#
# Note: PROJECT_ID, BUILD_ID, and other variables are automatically provided by Cloud Build

steps:
  # Step 1: Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t',
           '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REPO}/${_SERVICE_NAME}:${BUILD_ID}',
           '-t',
           '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REPO}/${_SERVICE_NAME}:latest',
           '.']

  # Step 2: Push the Docker image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '--all-tags',
           '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REPO}/${_SERVICE_NAME}']

  # Step 3: Deploy to Cloud Run
  # Only update the image, preserving all existing configuration (env vars, Cloud SQL, etc.)
  # The service must already exist (created by Terraform) with all required configuration
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args: ['run', 'services', 'update',
           '${_SERVICE_NAME}',
           '--image',
           '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REPO}/${_SERVICE_NAME}:${BUILD_ID}',
           '--region',
           '${_REGION}',
           '--platform',
           'managed']

# Substitution variables (should match your terraform configuration in /terraform)
substitutions:
  _REGION:
  _SERVICE_NAME:
  _ARTIFACT_REPO:

# Build configuration
options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

# Build timeout
timeout: 1200s

# Images to be stored in Artifact Registry
images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REPO}/${_SERVICE_NAME}:${BUILD_ID}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REPO}/${_SERVICE_NAME}:latest'
